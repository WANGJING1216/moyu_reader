# 摸鱼阅读 技术架构文档（基于 PRD v1.3）

## 1. 文档目标
- 依据 `摸鱼阅读_PRD_v1.3.docx` 输出 MVP 可落地技术架构。
- 覆盖功能架构、技术栈、数据模型、性能方案与研发管理体系。
- 支撑平台：iOS / Android（Flutter 单代码库）。

## 2. 总体技术选型
- 客户端框架：Flutter（Dart 3，Flutter 3.27+）
- 架构模式：Feature-first + Clean Architecture（Presentation / Domain / Data）
- 状态管理：Riverpod（含 `riverpod_generator`）
- 路由：`go_router`
- 本地存储：
  - 结构化元数据：`drift` + `sqlite3_flutter_libs`
  - 大文本原文：本地文件系统（`path_provider`）
- 文件导入：`file_picker`
- 编码检测与转换：`charset` + `gbk_codec`（UTF-8 / GBK）
- 性能并发：`Isolate.run`（章节解析、编码检测在后台线程）
- 传感器：`sensors_plus`（摇一摇老板键）
- 图片与头像：`image_picker`（P1）
- 日志与崩溃：`logger` + `sentry_flutter`（生产可选）
- 依赖注入：Riverpod Provider 容器（不额外引入 get_it）

## 3. 架构总览
```text
UI Layer (Flutter Widgets)
  ├─ ReaderPage（仿微信聊天 + 大气泡阅读）
  ├─ ChapterCatalogPage（目录页）
  ├─ FakeChatListPage（老板键目标页）
  └─ MenuSheet / ShelfPage / ImportFlow
          │
Application Layer (UseCases + State Notifier)
  ├─ ImportBookUseCase
  ├─ ParseChaptersUseCase
  ├─ SaveReadingProgressUseCase
  ├─ JumpToChapterUseCase
  └─ TriggerBossKeyUseCase
          │
Domain Layer (Entities + Repository Contracts)
  ├─ Book / Chapter / ReadingProgress / ChatMaskConfig
  └─ BookRepository / ReaderRepository / SettingsRepository
          │
Data Layer (Drift DAO + File Storage + Sensor Service)
  ├─ Local DB (books, chapters, progress, settings)
  ├─ TXT File Store
  ├─ Encoding Detector
  └─ ShakeDetector
```

## 4. 目录结构（推荐）
```text
lib/
  app/
    app.dart
    router.dart
    theme/
  core/
    constants/
    error/
    utils/
    performance/
  features/
    reader/
      presentation/
      application/
      domain/
      data/
    import_book/
    bookshelf/
    catalog/
    disguise/
    settings/
  shared/
    widgets/
    services/
```

## 5. 核心功能架构设计

## 5.1 阅读主界面（P0）
- UI 结构固定三层：顶部导航、中部聊天区、底部输入栏（仿微信）。
- 静态伪装消息与小说大气泡同属一个外层滚动容器；小说内容区为内层滚动容器。
- 嵌套滚动策略：
  - 手势优先驱动气泡内滚动；
  - 气泡到顶/底后将滚动事件传递外层。
- 右上角 `···` 为唯一设置入口，统一弹出菜单。

## 5.2 章节目录与跳转（P0）
- 长按左侧头像（阈值 `>=500ms`）触发目录页。
- 目录页独立路由，全屏右滑入场，点击章节后立即回退并定位。
- 当前章节定位：
  - 阅读页实时维护 `currentChapterId`；
  - 进入目录页后自动滚动至当前章节项中位。
- 状态显示：已读/当前/未读由 `ReadingProgress` 计算。

## 5.3 导入与解析（P0）
- 导入流程：选择 TXT -> 编码检测 -> 文本解码 -> 章节识别 -> 落盘。
- 章节识别规则：
  - 正则优先：`第[0-9一二三四五六七八九十百千]+章`、`Chapter\\s+\\d+` 等；
  - 失败降级：每 2000 字切片为一章。
- 性能策略：
  - 解码和章节解析在 Isolate 执行；
  - DB 采用批量事务写入；
  - 原文文件落地后仅存路径，避免内存长期持有大文本。

## 5.4 阅读进度（P0）
- 保存维度：`bookId + chapterId + innerScrollOffset + updatedAt`。
- 触发时机：
  - 页面 `AppLifecycleState.paused/inactive`；
  - 路由离开阅读页；
  - 切章后节流保存（如 2 秒）。
- 恢复机制：启动后进入上次阅读书籍并恢复章节与偏移。

## 5.5 老板键（P0）
- 触发源：
  - 底部 `+`：最高优先级，直接 `go('/fake-chat')`，目标 < 100ms。
  - 摇一摇：传感器阈值触发，目标 < 300ms。
- 低延迟实现：
  - 假聊天页数据本地常驻内存；
  - 首次启动即预热假聊天页面依赖；
  - 跳转使用无阻塞路由，不等待磁盘写入。

## 6. 数据模型设计（MVP）
```sql
books(
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  file_path TEXT NOT NULL,
  file_size INTEGER NOT NULL,
  encoding TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  last_read_at INTEGER
)

chapters(
  id TEXT PRIMARY KEY,
  book_id TEXT NOT NULL,
  title TEXT NOT NULL,
  start_offset INTEGER NOT NULL,
  end_offset INTEGER NOT NULL,
  sort_index INTEGER NOT NULL,
  FOREIGN KEY(book_id) REFERENCES books(id)
)

reading_progress(
  book_id TEXT PRIMARY KEY,
  chapter_id TEXT NOT NULL,
  inner_scroll_offset REAL NOT NULL,
  outer_scroll_offset REAL NOT NULL,
  updated_at INTEGER NOT NULL
)

settings(
  key TEXT PRIMARY KEY,
  value TEXT NOT NULL
)
```

## 7. 非功能指标落地方案
- 冷启动 < 2s：
  - 首屏仅初始化必要 Provider；
  - 延迟初始化书架统计等非关键任务。
- 50MB 导入 < 3s：
  - 后台 Isolate + 批量写入；
  - 分块读取（避免一次性字符串扩容）。
- 目录页进入 < 0.3s：
  - 目录数据提前缓存；
  - 路由动画控制在 200~250ms。
- 内存 < 150MB：
  - 只保留当前章节与邻近章节缓冲；
  - 退出时释放大文本解析缓存。
- 滚动帧率 >= 60fps（低端>=45fps）：
  - `RepaintBoundary` 隔离复杂区域；
  - 避免频繁 `setState`，使用选择性 Provider 监听。

## 8. 安全与隐私
- 全部数据本地存储，不接入云端上传（MVP）。
- 不记录用户书籍内容到外部日志。
- App 图标与启动文案保持中性，不暴露伪装用途。
- 后台切换时可选“快速遮罩”策略（后续版本）。

## 9. 工程规范与开发体系管理

## 9.1 分支与发布
- 分支模型：`main`（发布） + `develop`（日常集成） + `feature/*`。
- 版本规范：`v主.次.补丁`，MVP 建议 `v0.x`。
- 提交流程：PR 合并前必须通过 CI（分析、测试、构建）。

## 9.2 代码质量
- 必开：`flutter_lints` + 自定义 `analysis_options.yaml`。
- 统一格式：`dart format`。
- 提交规范：Conventional Commits（`feat:`, `fix:`, `refactor:`）。
- 关键路径（导入、跳章、老板键）必须有单元测试/集成测试覆盖。

## 9.3 测试策略
- 单元测试：UseCase、章节解析器、编码检测、进度恢复。
- Widget 测试：阅读页交互、目录页高亮、菜单入口。
- 集成测试：首次导入到阅读、老板键跳转、重启恢复进度。
- 性能测试：导入时长、目录页打开耗时、低端机滚动帧率。

## 9.4 CI/CD（建议 GitHub Actions）
- CI：
  - `flutter pub get`
  - `dart analyze`
  - `flutter test --coverage`
  - Android Debug 构建
  - iOS 无签名构建检查
- CD（可选）：
  - TestFlight / 内测渠道自动分发
  - 版本号与变更日志自动生成

## 10. 里程碑规划（4 周 MVP）
- 第 1 周：项目脚手架、主题仿微信 UI、基础路由、DB 基础层。
- 第 2 周：TXT 导入 + 章节解析 + 书架切书 + 进度持久化。
- 第 3 周：目录页跳转、嵌套滚动优化、老板键（+ 与摇一摇）。
- 第 4 周：性能优化、稳定性测试、打包与灰度发布。

## 11. 可扩展方向（MVP 后）
- EPUB 支持（解析服务独立化）。
- 多皮肤（企业微信/钉钉）策略化主题。
- 云端进度同步（账号体系 + 冲突合并）。
- 更强伪装策略（多入口行为配置化）。

## 12. 结论
- 该方案满足 PRD v1.3 的全部 P0 能力，并覆盖 P1 的工程预留。
- 通过 Flutter + Riverpod + Drift + Isolate 的组合，可在 MVP 阶段实现低复杂度与高性能平衡。
- 架构已为二期（EPUB、皮肤、云同步）保留清晰扩展路径。
