# 工1统一实施清单：P0-04 / P0-05 / P0-06 / P0-07

## 1. 目标与范围
- 目标：在已完成 `P0-04`（菜单入口）的基础上，完成 `P0-05/06/07` 联动闭环。
- 本轮必须交付：
  - `P0-04`：`···` 菜单入口可达（我的书架/导入新书）。
  - `P0-05`：TXT 导入闭环（选文件 -> 读取 -> 返回阅读页展示）。
  - `P0-06`：编码识别与回退（UTF-8 / GBK）。
  - `P0-07`：章节自动识别与 2000 字降级切章。
- 本轮不交付：
  - P0-08+（目录跳转、进度恢复、老板键增强）。

## 2. 强制要求（不可降级）

### 2.1 本地存储（强制）
- 导入成功后，书籍正文与章节索引必须落地到用户本地存储。
- 禁止上传正文到任何远端服务。
- 禁止日志/埋点输出正文内容。
- 阅读页展示内容必须来自本地持久化结果，而非仅内存变量。

### 2.2 编码支持（强制）
- 解码顺序：
  1. UTF-8；
  2. UTF-8 失败或疑似乱码时回退 GBK；
  3. 双失败则提示“编码不支持，请转为 UTF-8/GBK”。
- 不允许仅依赖 `allowMalformed` 作为最终成功标准。

### 2.3 章节解析（强制）
- 优先规则：识别 `第X章` / `Chapter X` 等常见标题。
- 降级规则：无有效标题时按每 2000 字切章，标题 `第X节`。
- 输出章节结构至少包含：`index/title/startOffset/endOffset`。

## 3. 参考资料
- `产品文档/摸鱼阅读_PRD_v1.4.docx`
- `docs/p0/00-总览与映射.md`
- `docs/p0/01-技术设计.md`
- `docs/p0/02-验收与测试.md`
- `samples/txt/chaptered_example.txt`
- `samples/txt/plain_example.txt`

## 4. 开发步骤（按顺序）
1. 打通菜单入口与导入流程。  
2. 接入文件选择，仅允许 `.txt`，处理用户取消分支。  
3. 读取文本并做空内容校验。  
4. 落实 UTF-8/GBK 解码与失败提示。  
5. 生成章节索引（规则识别 + 2000字降级切章）。  
6. 将正文和章节索引落地到本地存储。  
7. 导入成功回到阅读页展示正文，并保证失败路径稳定。  

## 5. 必测用例（验收）
- A：阅读页 `···` -> 导入新书 -> 打开文件选择器成功。
- B：导入 `chaptered_example.txt` -> 成功展示 -> 章节数 > 1。
- C：导入 `plain_example.txt` -> 成功展示 -> 触发 `第X节` 降级切章。
- D：GBK 编码 TXT 导入成功，中文无乱码。
- E：用户取消选择 -> 无错误提示、阅读内容不变。
- F：失败分支（空文本/不支持格式/读取失败）-> 有明确提示且不崩溃。
- G：导入后重启 App，仍能从本地读取文本与章节。

## 6. 本地验证命令
```bash
/Users/wangjing/tools/flutter-sdk/bin/flutter analyze
NO_PROXY=127.0.0.1,localhost /Users/wangjing/tools/flutter-sdk/bin/flutter test
```

## 7. 交付与记录要求
- 代码：实现 P0-04/05/06/07 联动能力。
- 文档：`changeLog.log` 必须记录：
  - 修改范围（本地存储 / GBK / 章节拆分 / 测试）；
  - 验证结果（analyze/test + 手工样本）；
  - 明确声明“书籍内容仅本地存储，不上传服务端”。

## 8. 通过标准
- 菜单入口、导入链路、编码回退、章节拆分均可复现。
- 导入结果本地持久化可在重启后读取。
- 全部必测用例通过且应用稳定无崩溃。
