# 工1需求文件：P0-11 / P0-12 / P0-13（分轮验收版）

## 0. 使用说明
- 本文档采用“基础需求 + 多轮验收”结构。
- 规则：每轮验收只追加，不覆盖历史内容，直到“最终验收通过”。

## 1. 基础需求（固定区）

### 1.1 目标与范围
- 目标：在已完成 `P0-08~P0-10` 的基础上，完成阅读进度自动保存、自动恢复、多书独立进度闭环。
- 本轮必须交付：
  - `P0-11`：阅读进度自动保存。
  - `P0-12`：阅读进度自动恢复。
  - `P0-13`：多书独立进度（按 `bookId` 隔离）。
- 本轮不交付：
  - `P0-14~P0-16`（老板键与假聊天列表页）
  - P1/P2/P3 全部需求

### 1.2 参考资料
- `docs/p0/00-总览与映射.md`
- `docs/p0/01-技术设计.md`
- `docs/p0/02-验收与测试.md`
- `docs/p0/04-实施清单_工1_P0-08到P0-10.md`
- `docs/需求技术文档_全局索引.md`（提交规范与 hooks）

### 1.3 PRD映射
- `P0-11` -> PRD `3.3`、`4.2(步骤3)`
- `P0-12` -> PRD `3.3`、`2.4(再次打开回到阅读位置)`、`4.2(步骤3)`
- `P0-13` -> PRD `3.3`

### 1.4 强制要求（技术口径）
- 进度必须本地持久化，禁止上传远端服务。
- 进度数据必须按 `bookId` 隔离，不允许多书互相污染。
- 恢复顺序必须是：先恢复章节，再恢复滚动偏移。
- 偏移恢复必须同时覆盖：
  - 小说气泡内层滚动（`innerOffset`）
  - 聊天区外层滚动（`outerOffset`）
- 保存时机必须至少覆盖：
  - App 进入后台（`paused/inactive`）
  - 离开阅读页（`dispose`）
  - 切章后
  - 滚动过程节流保存（建议 800ms，允许 `500~1000ms`）
- 不允许破坏已有 `P0-04~P0-10` 行为。

### 1.5 技术设计要求（必须落代码）
1. 进度实体
- 新增 `ReadingProgress`（或同等语义实体），字段至少包含：
  - `bookId`
  - `chapterIndex`
  - `innerOffset`
  - `outerOffset`
  - `updatedAt`

2. 持久化存储
- 新增独立进度存储服务（不要混入 `LocalBookStorage` 的书内容结构）。
- 推荐 key：`moyu_reader_reading_progress_v1`。
- 存储结构：`Map<String, ReadingProgressJson>`（key 为 `bookId`）。
- 读写异常必须兜底（返回默认进度，不能崩溃）。

3. `bookId` 生成规则（必须稳定）
- 优先使用 `sourcePath`。
- `sourcePath` 不可用时，使用稳定兜底 ID（禁止仅 `title|encoding`）。
- 要求在注释或文档中明确“为何可避免冲突”。

4. Reader 接入点
- `ReaderPage` 接入生命周期监听（`WidgetsBindingObserver`）。
- 接入滚动节流保存（监听内外滚动控制器）。
- 恢复流程放在章节内容渲染完成后执行（`addPostFrameCallback`）。
- 恢复偏移时必须做边界裁剪（clamp 到 min/maxExtent）。

5. 与现有会话内存态关系
- 允许保留 `ReaderProgressSessionStore` 作为运行期缓存。
- 但最终状态必须落持久化，且启动可从持久化恢复。

### 1.6 开发步骤
1. 新增进度实体与序列化模型。
2. 新增本地进度存储服务（读/写/按 bookId 查询）。
3. `ReaderPage` 接入生命周期保存、切章保存、滚动节流保存。
4. `ReaderPage` 启动/导入后恢复章节与偏移。
5. 完成多书切换场景隔离验证（A/B 两本书）。
6. 补齐自动化测试与回归测试。

### 1.7 提交规范（执行前确认）
- 提交前必须执行：
```bash
/Users/wangjing/tools/flutter-sdk/bin/flutter analyze
NO_PROXY=127.0.0.1,localhost /Users/wangjing/tools/flutter-sdk/bin/flutter test
```
- 提交信息必须符合 Conventional Commits。
- 必须启用 hooks（若未启用）：`./scripts/setup-git-hooks.sh`
- `changeLog.log` 必须记录：范围、文件、验证结果、风险与未完成项。

### 1.8 初始验收用例（固定）
- A：阅读中滚动后退后台，再次进入应用，恢复到原章节与偏移。
- B：切换章节后重启应用，恢复到切换后的章节与偏移。
- C：导入书A阅读到中部，再导入书B阅读到中部，重进后 A/B 进度互不污染。
- D：本地进度数据损坏场景不崩溃，自动回退默认进度。
- E：回归用例：`P0-08~P0-10` 目录与跳章能力不回退。
- F：全量 `flutter analyze` / `flutter test` 通过。

## 2. 第1轮验收结果（已闭环）

### 2.1 结论
- 结论：通过（功能验收通过，保留1项非阻塞优化建议）。

### 2.2 问题清单（本轮初始要求）
1. 进度未持久化（仅内存态）
- 现象：当前会话进度在重启后丢失。
- 修改要求：补齐本地持久化读写。

2. 生命周期保存缺失
- 现象：缺少后台/离页触发保存。
- 修改要求：接入生命周期监听并触发保存。

3. 偏移恢复缺失
- 现象：仅能恢复章节，不能恢复滚动位置。
- 修改要求：恢复 `innerOffset + outerOffset` 且做边界裁剪。

4. 多书隔离未落持久化
- 现象：当前 `bookId` 隔离主要在内存态，重启后无保证。
- 修改要求：按 `bookId` 持久化进度并验证 A/B 隔离。

### 2.3 第1轮修复 Checklist（工1回填）
- [x] 修复1完成：进度实体与本地存储落地。
- [x] 修复2完成：生命周期保存（后台/离页）接入。
- [x] 修复3完成：切章保存与滚动节流保存接入。
- [x] 修复4完成：章节+偏移恢复流程可用。
- [x] 修复5完成：多书隔离（bookId）持久化验证通过。
- [x] 自动化测试补充：保存与恢复主链路。
- [x] 自动化测试补充：多书隔离与坏数据兜底。
- [x] 回归测试补充：P0-08~P0-10 不回退。
- [x] `flutter analyze` 通过。
- [x] `flutter test` 通过。
- [x] `changeLog.log` 已更新本轮修复记录。

### 2.4 第1轮复验 Checklist（验收人勾选）
- [x] 用例1：退后台后进度自动保存并可恢复。
- [x] 用例2：重启后恢复章节与内外滚动偏移。
- [x] 用例3：A/B 两本书进度互不污染。
- [x] 用例4：坏数据场景不崩溃并回退默认进度。
- [x] 用例5：目录进入/章节跳转/状态展示能力正常（P0-08~P0-10 回归）。
- [x] 用例6：全量 analyze/test 通过。

### 2.5 风险观察（非阻塞，建议下一轮优化）
1. 进度持久化存在并发写覆盖风险
- 现象：`saveProgress()` 为“读全量 -> 写回全量”的读改写模型，且调用方未 `await`，高频触发下可能出现后写覆盖前写。
- 影响：极端情况下可能丢失某次进度更新（不影响本轮主链功能通过）。
- 优化建议：为 `ReadingProgressStorage` 增加串行写队列/互斥，或改为单 `bookId` 分key存储以规避覆盖。

## 3. 第N轮验收模板（复制追加）

### 3.X 第N轮验收结论
- 结论：通过 / 未通过（原因）。

### 3.X 第N轮问题清单
1. 问题描述
- 现象：
- 修改要求：

### 3.X 第N轮修复 Checklist（工1回填）
- [ ] 修复项1
- [ ] 修复项2
- [ ] 测试补充
- [ ] analyze/test 通过
- [ ] changeLog 更新

### 3.X 第N轮复验 Checklist（验收人勾选）
- [ ] 功能用例通过
- [ ] 回归用例通过
- [ ] 文档与日志一致

## 4. 最终验收通过标准（封板）
- 所有轮次问题均闭环，无阻塞缺陷。
- `P0-11/P0-12/P0-13` 基础需求与固定验收用例全部通过。
- 全量 `flutter analyze` / `flutter test` 通过。
- `changeLog.log` 记录完整，范围与实现一致。
