# 摸鱼阅读 P0需求技术文档 - 技术设计

## 3. 技术设计（按模块）

### 3.1 阅读核心模块（P0-01/P0-02/P0-03）
- 对应PRD：2、2.1、3.1、4.1、6。
- 页面结构：`ReaderPage` 分为顶部导航、中部聊天区、底部输入栏。
- 滚动模型：
  - 外层 `CustomScrollView` 承载静态聊天记录 + 小说气泡容器。
  - 内层 `Scrollable` 承载正文文本，采用边界传递策略处理嵌套滚动。
- UI规格落地：
  - 背景色 `#EDEDED`。
  - 对方气泡白色、自己气泡绿色（`#9FE175`）。
  - 小说气泡最大宽度 85%，默认字体 16sp，行距 1.6。
- 静态伪装层：默认 5~8 条记录，左右交替，不可交互。
- 性能要求：渲染目标 60fps，低端机最低 45fps（PRD 第6章）。

### 3.2 菜单与入口模块（P0-04）
- 对应PRD：2、2.1、2.2、5。
- 交互：仅右上角 `···` 可弹出菜单，保持微信交互一致。
- MVP菜单项：
  - `我的书架`（进入书架页）
  - `导入新书`（打开文件选择）
- 非P0菜单项（P1/P3）在本期可显示占位但不实现业务：
  - `调整字体`（P1，v1.4新增）
  - `联系人设置` / `自己头像设置` / `聊天内容自定义`（P1）
  - `切换皮肤`（P3，置灰）
 - 本阶段落地约束：
  - P0-04 保证“导入新书”入口可用并打通到 P0-05/06/07 流程。
  - 非 P0 菜单项仅保留入口占位，不验收业务逻辑。

### 3.3 导入解析模块（P0-05/P0-06/P0-07）
- 对应PRD：2.2、3.2、4.1、6、7。
- 导入流程（完整目标）：文件选择 -> 编码检测 -> 文本解码 -> 章节解析 -> 数据落盘 -> 进入阅读页。
- 输入约束：TXT、最大 50MB。
- 本阶段口径（必须一致）：
  - P0-05：完成 TXT 文件选择、读取、失败/取消处理、回到阅读页。
  - P0-06：完成编码识别与回退（UTF-8 / GBK）。
  - P0-07：完成章节识别与降级切章（2000字）。
- P0-05/06/07 实现要求（本阶段全部验收）：
  - 文件选择：仅允许 `.txt`，取消选择静默返回。
  - 编码策略：优先 UTF-8，失败回退 GBK，仍失败提示用户转换编码。
  - 章节策略：优先识别 `第X章` / `Chapter X` 等标题；失败按每 2000 字切章（标题 `第X节`）。
  - 存储策略：导入内容与章节索引落用户本地，禁止上传远端。
  - 展示链路：导入成功后返回阅读页并展示导入内容；目录页可读取章节列表。
  - 稳定性：失败路径均给出提示且不崩溃。
- 完整目标性能（本阶段）：
  - 50MB 导入 < 3 秒。
  - 500章内解析 < 1 秒。
- 联调样本目录：`samples/txt/`
  - `chaptered_example.txt`：验证“章节标题识别”主路径。
  - `plain_example.txt`：验证“2000字降级切章”路径。

### 3.4 目录跳转模块（P0-08/P0-09/P0-10）
- 对应PRD：2.3、3.4、4.1、6。
- 触发条件：长按左侧头像 `>= 0.5s`。
- 路由与动画：全屏目录页右滑入场，进入耗时 < 0.3s。
- 列表规则：
  - 默认自动定位当前章节至屏幕中部。
  - 章节项高度 56dp，字号 16sp。
- 状态规则：
  - 已读：灰字 + 灰勾。
  - 当前：蓝字 + 蓝点。
  - 未读：黑字。
- 跳转规则：点击章节后关闭目录页并定位章节首行。

### 3.5 进度管理模块（P0-11/P0-12/P0-13）
- 对应PRD：3.3、2.4、4.2。
- 数据字段：`bookId`、`chapterId`、`innerScrollOffset`、`outerScrollOffset`、`updatedAt`。
- 保存时机：
  - App 进入后台；
  - 离开阅读页；
  - 切章后节流保存。
- 恢复规则：
  - 启动后读取最近阅读书籍；
  - 先恢复章节，再恢复滚动偏移。
- 多书隔离：以 `bookId` 为主键保证每本书单独进度。

### 3.6 老板键模块（P0-14/P0-15/P0-16）
- 对应PRD：2、2.1、2.4、4.2、5、6、7。
- 触发能力：
  - 底部 `+` 点击触发（主路径，<0.1s）。
  - 摇一摇触发（备用，<0.3s）。
- 页面目标：`FakeChatListPage`，展示 2~3 条静态会话，不可进入详情。
- 风险控制：摇一摇阈值需抬高，支持设置开关（误触风险对应 PRD 第7章）。
- 状态连续性：从假聊天页重新回到应用后，继续上次阅读位置。

## 4. 数据与存储规格（P0）
- `books`：书籍元信息（文件路径、编码、创建时间、最近阅读时间）。
- `chapters`：章节索引（标题、文本偏移、排序）。
- `reading_progress`：按 `bookId` 存储阅读进度。
- `settings`：摇一摇开关等基础设置。
- 原文存储：TXT 原文落地本地文件，数据库仅存元信息与索引。

## 5. 路由与页面清单（P0）
- `/reader`：阅读主页面。
- `/catalog`：章节目录页。
- `/fake-chat`：假聊天列表页。
- `/bookshelf`：书架页入口（P0 仅保证入口与基础展示）。
