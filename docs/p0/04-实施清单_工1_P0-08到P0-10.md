# 工1需求文件：P0-08 / P0-09 / P0-10（分轮验收版）

## 0. 使用说明
- 本文档采用“基础需求 + 多轮验收”结构。
- 规则：每轮验收只追加，不覆盖历史内容，直到“最终验收通过”。

## 1. 基础需求（固定区）

### 1.1 目标与范围
- 目标：在已具备 `P0-07` 章节索引能力的基础上，完成目录页进入、章节跳转、章节状态展示闭环。
- 本轮必须交付：
  - `P0-08`：长按头像进入目录页（>= 0.5s）。
  - `P0-09`：点击章节跳转并返回阅读页定位到章节首行。
  - `P0-10`：目录中显示当前章高亮和已读状态。
- 本轮不交付：
  - `P0-11~13`（阅读进度持久化）
  - `P0-14~16`（老板键与假聊天页）

### 1.2 参考资料
- `docs/p0/00-总览与映射.md`
- `docs/p0/01-技术设计.md`
- `docs/p0/02-验收与测试.md`
- `docs/p0/03-实施清单_工1_P0-04到P0-07.md`
- `docs/需求技术文档_全局索引.md`（提交规范与 hooks）

### 1.3 强制要求
- 目录数据必须复用导入结果中的章节索引（不重复造数据）。
- 长按触发阈值必须可配置（默认 500ms）。
- 目录返回路径必须完整（顶部返回、边缘右滑返回、空白区域返回若有遮罩）。
- 跳转后阅读定位必须准确到目标章节 `startOffset`。
- 不允许破坏已有 `P0-04/05/06/07` 行为。

### 1.4 开发步骤
1. 新建目录页路由与页面骨架（`/catalog`）。
2. 阅读页接入头像长按检测并跳转目录页。
3. 目录页加载章节列表并默认定位当前章节。
4. 点击章节返回阅读页并按 `startOffset` 定位。
5. 完成当前/已读/未读状态展示。
6. 完成异常兜底（无章节、空参数、坏数据）。

### 1.5 提交规范（执行前确认）
- 提交前必须执行：
```bash
/Users/wangjing/tools/flutter-sdk/bin/flutter analyze
NO_PROXY=127.0.0.1,localhost /Users/wangjing/tools/flutter-sdk/bin/flutter test
```
- 提交信息必须符合 Conventional Commits。
- 必须启用 hooks（若未启用）：`./scripts/setup-git-hooks.sh`
- `changeLog.log` 必须记录：范围、文件、验证结果、风险与未完成项。

### 1.6 初始验收用例（固定）
- A：长按阅读头像 >= 0.5s 可进入目录页。
- B：目录页进入时自动滚动到当前章附近。
- C：点击任意章节后返回阅读页并定位到章节首行。
- D：当前章高亮、已读章状态显示正确。
- E：无章节数据场景有可见提示且不崩溃。
- F：回归用例：`flutter test` 全量通过，不破坏导入链路。

## 2. 第1轮验收结果（已闭环）

### 2.1 结论
- 结论：通过（已完成复验并闭环）。

### 2.2 问题清单（本轮）
1. 章节识别单章标题误判
- 现象：`titleHits >= 2` 才按标题分章，单章标题误走降级切章。
- 修改要求：`titleHits >= 1` 即按标题分章，最后一章结束位置=全文末尾。

2. 已读状态回退丢失
- 现象：跳章时重建 `0..selectedIndex`，回跳前章导致后章“已读”丢失。
- 修改要求：已读集合采用并集更新，不因回跳丢失历史已读。

3. `/catalog` 路由空参数崩溃风险
- 现象：路由强制解包 `settings.arguments!`。
- 修改要求：空参兜底（回退阅读页或错误页），不得崩溃。

4. 本地坏数据恢复无兜底
- 现象：本地 JSON 解析/类型转换无异常处理。
- 修改要求：捕获异常并返回 `null`（必要时清理坏数据）。

### 2.3 第1轮修复 Checklist（工1回填）
- [x] 修复1完成：单章标题按标题分章。
- [x] 修复2完成：已读状态并集更新。
- [x] 修复3完成：`/catalog` 空参数兜底。
- [x] 修复4完成：本地坏数据兜底。
- [x] 自动化测试补充：覆盖修复1。
- [x] 自动化测试补充：覆盖修复2。
- [x] 自动化测试补充：覆盖修复3或修复4 至少1条。
- [x] `flutter analyze` 通过。
- [x] `flutter test` 通过。
- [x] `changeLog.log` 已更新本轮修复记录。

### 2.4 第1轮复验标准（验收人勾选）
- [x] 用例1：单章标题不误降级为 `第1节`。
- [x] 用例2：回跳后已读状态不丢失。
- [x] 用例3：`/catalog` 空参数场景不崩溃。
- [x] 用例4：本地坏数据场景不崩溃。
- [x] 全量 analyze/test 通过。

## 3. 第2轮验收结果（已闭环）

### 3.1 结论
- 结论：通过（PRD 对齐项已完成并复验通过）。

### 3.2 问题清单（本轮）
1. 目录页入场动画与时延指标未形成可验收实现
- 现象：当前 `catalog` 路由使用默认 `MaterialPageRoute`，未体现“右滑入场”与“<0.3s”可验证实现。
- 修改要求：补充自定义路由转场（右滑入场）与性能验收方法（测试/埋点/手测口径至少一种）。
- 依据：`docs/p0/01-技术设计.md` 第3.4节“路由与动画：全屏目录页右滑入场，进入耗时 < 0.3s”。

2. 目录状态视觉不完全符合规格
- 现象：当前状态以文本“当前/已读/未读”为主，缺少“当前蓝点、已读灰勾”的视觉标识。
- 修改要求：在保留文本可读性的前提下，补齐蓝点/灰勾视觉标识；或在文档中明确降级方案并获验收确认。
- 依据：`docs/p0/01-技术设计.md` 第3.4节状态规则。

3. 多书独立进度边界未固化（与后续 P0-11~P0-13 强耦合）
- 现象：当前章节状态管理以单书当前会话为主，尚未在本轮文档与测试中明确“按 bookId 隔离”的约束。
- 修改要求：在本轮实现中预留多书隔离接口/数据结构（至少在文档与测试口径中明确），避免后续进度持久化改造返工。
- 依据：`docs/p0/00-总览与映射.md`（多书独立进度）与 `docs/p0/01-技术设计.md` 第3.5节（`bookId` 隔离）。

### 3.3 第2轮修复 Checklist（工1回填）
- [x] 修复1完成：目录页右滑入场动画实现。
- [x] 修复2完成：目录页进入耗时 < 0.3s 的验收口径可执行。
- [x] 修复3完成：目录状态补齐蓝点/灰勾或完成降级方案评审。
- [x] 修复4完成：多书独立进度约束已在实现注释/设计说明中明确（按 `bookId` 隔离）。
- [x] 自动化测试或可复现手测步骤补充（覆盖修复1、修复3、修复4）。
- [x] `flutter analyze` 通过。
- [x] `flutter test` 通过。
- [x] `changeLog.log` 已更新本轮修复记录。

### 3.4 第2轮复验 Checklist（验收人勾选）
- [x] 用例1：长按头像进入目录，转场为右滑入场。
- [x] 用例2：目录页进入时延满足 < 0.3s（按约定口径验证通过）。
- [x] 用例3：当前章为蓝点/蓝色高亮，已读章为灰勾/灰色标记。
- [x] 用例4：点击章节跳回阅读页并定位章节首行（回归验证）。
- [x] 用例5：切换不同书籍时章节状态互不污染（book A/B 独立）。
- [x] 用例6：`flutter analyze` / `flutter test` 全量通过。

## 4. 第N轮验收模板（复制追加）

### 4.X 第N轮验收结论
- 结论：通过 / 未通过（原因）。

### 4.X 第N轮问题清单
1. 问题描述
- 现象：
- 修改要求：

### 4.X 第N轮修复 Checklist（工1回填）
- [ ] 修复项1
- [ ] 修复项2
- [ ] 测试补充
- [ ] analyze/test 通过
- [ ] changeLog 更新

### 4.X 第N轮复验 Checklist（验收人勾选）
- [ ] 功能用例通过
- [ ] 回归用例通过
- [ ] 文档与日志一致

## 5. 最终验收通过标准（封板）
- 所有轮次问题均闭环，无阻塞缺陷。
- 基础需求与固定验收用例全部通过。
- 全量 `flutter analyze` / `flutter test` 通过。
- `changeLog.log` 记录完整，范围与实现一致。
