# 工1需求文件：P0-17 书架最小闭环（待启动）

## 0. 启动门禁（必须满足）
- 当前状态：`待启动`。
- 启动条件：`docs/p0/05-实施清单_工1_P0-11到P0-13.md` 本轮验收结论为“通过”且复验 checklist 全勾选。
- 未满足前：禁止提交 P0-17 功能代码（仅允许阅读文档与技术准备）。

## 1. 基础需求（固定区）

### 1.1 目标与范围
- 目标：基于 PRD v1.5 新增内容，落地与 `P0-13` 强耦合的“书架最小闭环”。
- 本轮必须交付（最小范围）：
  - `···` 菜单进入“我的书架”页。
  - 书架列表展示：书名 + 阅读进度 + 当前阅读标签。
  - 点击书籍切换阅读并恢复该书进度（复用 P0-13 持久化）。
  - 返回阅读页后保持现有伪装 UI 结构不变。
- 本轮不交付：
  - 长按删除、书架内导入、20本上限、完整书架管理能力（留到 P1）。

### 1.2 参考资料
- `docs/p0/00-总览与映射.md`
- `docs/p0/01-技术设计.md`
- `docs/p0/02-验收与测试.md`
- `docs/p0/05-实施清单_工1_P0-11到P0-13.md`
- `docs/需求技术文档_全局索引.md`
- `原型文档/moyureader-v2.html`（书架原型已实现）

### 1.3 PRD映射（v1.5）
- 对应章节：
  - `2.2`（菜单“我的书架”入口）
  - `3.4`（书架入口、列表、切换阅读、返回）
  - `3.5`（多书独立记录）
- 对应条目：`P0-17 书架最小闭环（与P0-13耦合）`。

### 1.4 原型对应（已确认）
- `menu-shelf`：菜单入口。
- `screen-shelf`：书架页。
- `.book-card`：点击切书并返回阅读页。
- `active-book`：当前阅读高亮。
- `book-progress-txt`：进度文案展示。

### 1.5 强制要求（技术口径）
- 必须复用 `P0-11~P0-13` 的进度持久化，不得重复造进度存储。
- 切书后必须恢复该书章节与偏移（章节优先，偏移后置恢复）。
- 书架展示的“当前阅读中”状态必须与 `ReaderPage` 当前书一致。
- 所有数据仅本地存储，禁止上传远端。
- 不允许破坏 `P0-08~P0-13` 已通过能力。

### 1.6 技术设计要求（必须落代码）
1. 数据来源
- 书籍列表来自本地已导入书籍集合（避免硬编码假数据）。
- 每本书展示字段：`bookId/title/currentChapterIndex/progressPercent/isCurrentReading`。

2. 页面与路由
- 新增（或补全）`BookshelfPage` 数据化渲染。
- 入口保持 `ReaderPage -> ··· -> 我的书架`。
- 切书后回到 `ReaderPage`，并使用统一切书接口完成状态切换。

3. 与进度系统联动
- 列表中的“第X章 · 已读Y%”由持久化进度计算，不可写死。
- 点击书籍后：
  - 激活当前书标记；
  - 恢复该书 `chapterIndex + inner/outer offset`；
  - 同步更新目录页状态基础数据。

4. 异常兜底
- 无导入书籍：显示空态，不崩溃。
- 书籍数据损坏：跳过损坏项并提示（可降级 toast/snackbar）。
- 当前阅读书被移除（若未来扩展删除）：回退到可用书籍或空态。

### 1.7 开发步骤
1. 梳理本地书籍清单数据结构（与导入存储对齐）。
2. 改造 `BookshelfPage` 为真实数据渲染。
3. 打通点击书籍 -> 切换 `ReaderPage` 当前书 -> 恢复进度链路。
4. 接入“当前阅读中”标签与进度文案计算。
5. 补充测试（功能 + 回归）。

### 1.8 提交规范（执行前确认）
- 提交前必须执行：
```bash
/Users/wangjing/tools/flutter-sdk/bin/flutter analyze
NO_PROXY=127.0.0.1,localhost /Users/wangjing/tools/flutter-sdk/bin/flutter test
```
- 提交信息必须符合 Conventional Commits。
- 必须启用 hooks（若未启用）：`./scripts/setup-git-hooks.sh`
- `changeLog.log` 必须记录：范围、文件、验证结果、风险与未完成项。

### 1.9 初始验收用例（固定）
- A：阅读页菜单进入书架页成功。
- B：书架列表显示已导入书籍，含进度文案。
- C：点击非当前书后切换阅读成功，恢复该书进度。
- D：切换后书架“当前阅读中”标签更新正确。
- E：无书场景空态可见且不崩溃。
- F：`P0-08~P0-13` 回归通过。
- G：全量 `flutter analyze` / `flutter test` 通过。

## 2. 第1轮验收结果（待启动）

### 2.1 结论
- 结论：未启动（等待 P0-11~P0-13 本轮验收门禁通过）。

### 2.2 启动前检查（验收人勾选）
- [ ] `docs/p0/05-实施清单_工1_P0-11到P0-13.md` 结论为“通过”。
- [ ] 本轮复验 checklist 全部勾选完成。
- [ ] `changeLog.log` 记录与文档状态一致。

### 2.3 第1轮修复 Checklist（工1回填）
- [ ] 入口与路由打通完成。
- [ ] 书架列表真实数据渲染完成。
- [ ] 切书并恢复进度链路完成。
- [ ] 当前阅读标签与进度文案完成。
- [ ] 异常兜底与空态完成。
- [ ] 自动化测试补充完成。
- [ ] 回归测试（P0-08~P0-13）通过。
- [ ] `flutter analyze` 通过。
- [ ] `flutter test` 通过。
- [ ] `changeLog.log` 已更新本轮记录。

### 2.4 第1轮复验 Checklist（验收人勾选）
- [ ] 用例A-G 全通过。
- [ ] 文档、代码、changelog 三方一致。

## 3. 第N轮验收模板（复制追加）

### 3.X 第N轮验收结论
- 结论：通过 / 未通过（原因）。

### 3.X 第N轮问题清单
1. 问题描述
- 现象：
- 修改要求：

### 3.X 第N轮修复 Checklist（工1回填）
- [ ] 修复项1
- [ ] 修复项2
- [ ] 测试补充
- [ ] analyze/test 通过
- [ ] changeLog 更新

### 3.X 第N轮复验 Checklist（验收人勾选）
- [ ] 功能用例通过
- [ ] 回归用例通过
- [ ] 文档与日志一致

## 4. 最终验收通过标准（封板）
- 所有轮次问题均闭环，无阻塞缺陷。
- `P0-17` 基础需求与固定验收用例全部通过。
- 全量 `flutter analyze` / `flutter test` 通过。
- `changeLog.log` 记录完整，范围与实现一致。
