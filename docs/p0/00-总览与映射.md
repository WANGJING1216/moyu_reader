# 摸鱼阅读 P0需求技术文档 - 总览与映射

## 1. 文档目的与范围
- 目的：将 `docs/功能条目拆分.md` 中 P0 条目转为可开发的技术规格。
- 范围：覆盖 `P0-01 ~ P0-17`（含 v1.5 新增的 P0 扩展项），不包含 P2/P3。
- 基线文档：`产品文档/摸鱼阅读_PRD_v1.5.docx`。
- 原型文档：`原型文档/moyureader-v2.html`。

## 1.1 v1.4 / v1.5 对 P0 的影响说明
- PRD v1.4 新增“字体大小调节”完整描述（§3.2），该能力在优先级上属于 P1，不纳入本 P0 交付范围。
- 对 P0 的直接影响：
  - `P0-04` 菜单信息架构需预留“调整字体”入口位（可占位、不可落业务）。
  - `P0-05` 导入链路设计与验收不变，但需与后续字体设置持久化能力共存。
- PRD v1.5 在开头索引新增“书架页（§3.4）”完整描述（界面规格/交互说明/入口设计）。
- 项目内判定：该新增能力与 `P0-13 多书独立进度` 强耦合，需前置一个 P0 扩展需求以形成“多书进度可达闭环”。
  - 新增条目：`P0-17 书架最小闭环（入口 + 切书 + 当前阅读标识 + 进度展示）`。
  - 说明：完整书架管理仍按 PRD 定义属于 P1；本阶段仅实现与 P0-13 直接相关的最小可用子集。

## 2. P0条目与PRD映射总表
| P0编号 | 功能条目 | 对应PRD章节 |
|---|---|---|
| P0-01 | 仿微信阅读主界面框架 | 2、2.1、3.1、4.1(步骤1) |
| P0-02 | 小说大气泡独立滚动 | 2、3.1、6(滚动帧率) |
| P0-03 | 静态伪装聊天区 | 3.1(静态聊天内容区) |
| P0-04 | 右上角菜单统一入口 | 2、2.1、2.2、5(P0:「···」菜单统一入口) |
| P0-05 | TXT导入 | 2.2(导入新书)、3.2、4.1(步骤3/4)、6(导入耗时) |
| P0-06 | 编码识别与解码 | 3.2、7(GBK编码乱码风险) |
| P0-07 | 章节自动解析 | 3.2、7(章节解析失败风险)、6(解析耗时) |
| P0-08 | 章节目录页进入 | 2.3、3.4、4.1(步骤6)、6(目录页进入时间) |
| P0-09 | 章节跳转 | 2.3、3.4、4.1(步骤7) |
| P0-10 | 当前章节高亮与已读状态 | 2.3(章节状态识别)、3.4(进度感知) |
| P0-11 | 阅读进度自动保存 | 3.3、4.2(步骤3) |
| P0-12 | 阅读进度自动恢复 | 3.3、2.4(再次打开回到阅读位置)、4.2(步骤3) |
| P0-13 | 多书独立进度 | 3.3 |
| P0-17 | 书架最小闭环（与P0-13耦合） | 2.2(我的书架入口)、3.4(书架入口/切换/进度展示)、3.5(多书独立记录) |
| P0-14 | 老板键-加号触发 | 2、2.1、2.4、4.2(步骤2a)、6(<0.1s) |
| P0-15 | 老板键-摇一摇触发 | 2、2.4、4.2(步骤2b)、6(<0.3s)、7(误触风险) |
| P0-16 | 假聊天列表页 | 2.4、5(P0:假聊天列表页) |

### 2.1 P0条目与原型对应（`原型文档/moyureader-v2.html`）
| P0编号 | 原型对应点（页面/元素/脚本） | 对应结论 |
|---|---|---|
| P0-01 | `#screen-reading`、`.nav-bar`、`.chat-area`、`.input-bar` | 已实现（界面结构完整） |
| P0-02 | `.chat-area{overflow-y:auto}` + `.bubble-content{overflow-y:auto}` | 部分实现（双层滚动存在，但未做严格“边界传递”控制） |
| P0-03 | `#chat-area` 内置多条 `.msg-row` 静态聊天 | 已实现（静态伪装层可见且不可回复） |
| P0-04 | `#btn-menu` + `#ctx-menu` + `openMenu()/closeMenu()` | 已实现（统一菜单入口） |
| P0-05 | `#menu-import`、`simulateImportFlow()` | 原型模拟（Toast流程，无真实文件选择与落盘） |
| P0-06 | `simulateImportFlow()` 文案包含 UTF-8/GBK | 未实现（无真实编码检测） |
| P0-07 | `CHAPTERS`、`chapterTexts` 为预置数据 | 未实现（无真实章节解析与降级切分） |
| P0-08 | `#avatar` 长按触发 `startLongPress()` -> `openChapterPanel()`（550ms） | 已实现（满足 `>=0.5s`） |
| P0-09 | `jumpToChapter(idx)`、`goTo('reading','back')`、`bubble-content.scrollTop=0` | 已实现（点击章节跳回并定位章节首行） |
| P0-10 | `initChapterList()` 中 `cur/read` 样式与状态标记 | 已实现（当前/已读/未读可区分） |
| P0-11 | 全局无 `localStorage/indexedDB` 持久化逻辑 | 未实现（未保存进度） |
| P0-12 | 初始化仅 `initBubble()`，无启动恢复逻辑 | 未实现（无自动恢复） |
| P0-13 | 书籍切换仅 UI 高亮，未绑定独立进度存储 | 未实现（无多书进度隔离） |
| P0-17 | `#menu-shelf` 进入 `#screen-shelf`；`.book-card` 点击切书并 `goTo('reading','back')`；`active-book` 高亮与 `book-progress-txt` 进度文案 | 原型已实现（入口/切书/当前阅读态/进度展示齐全） |
| P0-14 | `#btn-boss` 点击 -> 80ms 后 `goTo('boss')` | 已实现（交互路径完整） |
| P0-15 | `devicemotion` 监听，阈值 `dx+dy+dz>30`，1s 节流 | 已实现（摇一摇触发已接入） |
| P0-16 | `#screen-boss` + 2~3 条 `.fake-item` 静态会话 | 已实现（假聊天列表页面） |

### 2.2 原型到正式开发的补充项（仅针对未完成P0）
- 导入链路：替换 `simulateImportFlow()`，接入真实文件选择、编码检测、章节解析、数据库与文件落盘（P0-05/06/07）。
- 进度系统：新增 `reading_progress` 持久化，覆盖保存、恢复、多书隔离（P0-11/12/13）。
- 嵌套滚动：在 Flutter 中实现“内层优先、边界传递”手势策略，补齐 P0-02 的严格交互要求。
- 书架最小闭环：在完整 P1 书架前，先落“可切书并正确恢复该书进度”的最小链路（P0-17）。
  - 原型依据：`原型文档/moyureader-v2.html` 已提供菜单入口（`menu-shelf`）、书架页（`screen-shelf`）、当前书高亮（`active-book`）、进度文案（`book-progress-txt`）与切书回读（`goTo('reading','back')`）行为。

### 2.3 当前阶段执行重点（P0-04 -> P0-05/06/07）
- 本轮执行目标：从“菜单入口可达（P0-04）”推进到“可导入并可解析目录的闭环（P0-05/06/07）”。
- 强约束：
  - 必须实现：`P0-05 TXT导入` + `P0-06 编码识别（UTF-8/GBK）` + `P0-07 章节解析与降级切章`。
  - 非 P0 能力（如 P1 字体设置）仅保留入口占位，不落业务。
- 联调输入：优先使用 `samples/txt/` 目录下示例文件进行导入与章节验证。

### 2.4 下一阶段执行重点（P0-08 -> P0-10）
- 执行目标：完成目录页进入、章节跳转、当前/已读状态展示。
- 依赖前提：复用 P0-07 产出的章节索引数据结构。
- 交付文档：`docs/p0/04-实施清单_工1_P0-08到P0-10.md`。

### 2.5 当前阶段状态（截至 v1.5）
- `P0-11/12/13` 已进入“完成并通过第1轮验收”状态。
- 阶段结论：可进入与 `P0-13` 强耦合的下一条需求开发。

### 2.6 下一步执行重点（P0-13 完成后立即启动）
- 启动条目：`P0-17 书架最小闭环（v1.5 新增）`。
- 执行顺序：`P0-13 验收完成 -> P0-17 开发 -> P0-17 验收`。
- 本轮最小交付范围（严格控 scope）：
  - `···` 菜单进入“我的书架”页面；
  - 书籍列表展示：书名 + 阅读进度 + 当前阅读标签；
  - 点击书籍切换阅读并恢复该书进度（复用 `P0-13` 持久化）；
  - 返回阅读页后保持原伪装 UI 结构不变。
- 本轮不交付：
  - 长按删除、书架内导入、20本上限等完整管理能力（保留到 P1 完整书架阶段）。
- 计划交付文档：`docs/p0/06-实施清单_工1_P0-17书架最小闭环.md`。
