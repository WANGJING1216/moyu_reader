#!/usr/bin/env bash
set -euo pipefail

MSG_FILE="${1:-}"
if [[ -z "$MSG_FILE" || ! -f "$MSG_FILE" ]]; then
  echo "[commit-msg] missing commit message file." >&2
  exit 1
fi

FIRST_LINE="$(head -n1 "$MSG_FILE" | tr -d '\r')"

# Allow merge/revert commits generated by git.
if [[ "$FIRST_LINE" =~ ^Merge\  ]] || [[ "$FIRST_LINE" =~ ^Revert\  ]]; then
  exit 0
fi

PATTERN='^(feat|fix|refactor|test|docs|chore)(\([a-z0-9_-]+\))?: .+'
if ! [[ "$FIRST_LINE" =~ $PATTERN ]]; then
  cat >&2 <<'EOF'
[commit-msg] invalid commit message.
Expected format:
  <type>(optional-scope): <subject>
Allowed types:
  feat, fix, refactor, test, docs, chore
Examples:
  feat(import): support utf8/gbk decode fallback
  fix(reader): handle import cancel without state mutation
EOF
  exit 1
fi
